---
  - hosts: gws
    tasks:
      - name: Install all required packages
        apt: name={{item}} state=installed update_cache=false
        with_items:
          - bsd-mailx

      - name: copy
        command: cp "/lib/systemd/system/fastd@.service" /etc/systemd/system/

      - name: copy secret
        copy: src=secrets/fastd-{{gw}}.secret.conf dest=/etc/fastd/{{item}}/secret.conf
        with_items:
            - vpn00
            - vpn01
            - vpn02
            - vpn03
            - vpn04

      - name: copy secret
        copy: src=secrets/fastd-{{gw}}{{instance}}.secret.conf dest=/etc/fastd/{{item}}/secret.conf
        with_items:
            - vpn00bb
            - vpn01bb
            - vpn02bb
            - vpn03bb
            - vpn04bb

      - service: name=fastd@vpn00 enabled=yes
      - service: name=fastd@vpn00bb enabled=yes
      - service: name=fastd@vpn01 enabled=yes
      - service: name=fastd@vpn01bb enabled=yes
      - service: name=fastd@vpn02 enabled=yes
      - service: name=fastd@vpn02bb enabled=yes
      - service: name=fastd@vpn03 enabled=yes
      - service: name=fastd@vpn03bb enabled=yes
      - service: name=fastd@vpn04 enabled=yes
      - service: name=fastd@vpn04bb enabled=yes
      - git: repo=https://github.com/freifunk-stuttgart/peers-ffs.git dest=/etc/fastd/peers-ffs update=yes
      - cron: name="fastd" minute="*/5" job="git -C /etc/fastd/peers-ffs pull  > /dev/null && killall -HUP fastd"

